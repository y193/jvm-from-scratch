#include <assert.h>
#include <stddef.h>

#include "classfile.h"

const uint8_t bytes_Object_class[] = {
    202, 254, 186, 190, 0,   3,   0,   45,  0,   63,  3,   0,   7,   161, 32,
    8,   0,   41,  7,   0,   61,  7,   0,   43,  7,   0,   52,  7,   0,   56,
    7,   0,   42,  7,   0,   31,  7,   0,   44,  10,  0,   9,   0,   22,  10,
    0,   4,   0,   23,  10,  0,   9,   0,   19,  10,  0,   7,   0,   24,  10,
    0,   5,   0,   25,  10,  0,   4,   0,   20,  10,  0,   4,   0,   18,  10,
    0,   9,   0,   21,  12,  0,   40,  0,   27,  12,  0,   57,  0,   28,  12,
    0,   59,  0,   50,  12,  0,   39,  0,   45,  12,  0,   60,  0,   29,  12,
    0,   51,  0,   62,  12,  0,   40,  0,   49,  12,  0,   34,  0,   27,  1,
    0,   21,  40,  76,  106, 97,  118, 97,  47,  108, 97,  110, 103, 47,  79,
    98,  106, 101, 99,  116, 59,  41,  90,  1,   0,   20,  40,  41,  76,  106,
    97,  118, 97,  47,  108, 97,  110, 103, 47,  83,  116, 114, 105, 110, 103,
    59,  1,   0,   3,   40,  41,  73,  1,   0,   19,  40,  41,  76,  106, 97,
    118, 97,  47,  108, 97,  110, 103, 47,  67,  108, 97,  115, 115, 59,  1,
    0,   13,  67,  111, 110, 115, 116, 97,  110, 116, 86,  97,  108, 117, 101,
    1,   0,   19,  106, 97,  118, 97,  47,  108, 97,  110, 103, 47,  84,  104,
    114, 111, 119, 97,  98,  108, 101, 1,   0,   9,   110, 111, 116, 105, 102,
    121, 65,  108, 108, 1,   0,   10,  69,  120, 99,  101, 112, 116, 105, 111,
    110, 115, 1,   0,   7,   103, 101, 116, 78,  97,  109, 101, 1,   0,   15,
    76,  105, 110, 101, 78,  117, 109, 98,  101, 114, 84,  97,  98,  108, 101,
    1,   0,   10,  83,  111, 117, 114, 99,  101, 70,  105, 108, 101, 1,   0,
    14,  76,  111, 99,  97,  108, 86,  97,  114, 105, 97,  98,  108, 101, 115,
    1,   0,   4,   67,  111, 100, 101, 1,   0,   4,   119, 97,  105, 116, 1,
    0,   8,   116, 111, 83,  116, 114, 105, 110, 103, 1,   0,   1,   64,  1,
    0,   17,  106, 97,  118, 97,  47,  108, 97,  110, 103, 47,  73,  110, 116,
    101, 103, 101, 114, 1,   0,   22,  106, 97,  118, 97,  47,  108, 97,  110,
    103, 47,  83,  116, 114, 105, 110, 103, 66,  117, 102, 102, 101, 114, 1,
    0,   16,  106, 97,  118, 97,  47,  108, 97,  110, 103, 47,  79,  98,  106,
    101, 99,  116, 1,   0,   4,   40,  74,  41,  86,  1,   0,   6,   110, 111,
    116, 105, 102, 121, 1,   0,   20,  40,  41,  76,  106, 97,  118, 97,  47,
    108, 97,  110, 103, 47,  79,  98,  106, 101, 99,  116, 59,  1,   0,   5,
    40,  74,  73,  41,  86,  1,   0,   22,  40,  73,  73,  41,  76,  106, 97,
    118, 97,  47,  108, 97,  110, 103, 47,  83,  116, 114, 105, 110, 103, 59,
    1,   0,   44,  40,  76,  106, 97,  118, 97,  47,  108, 97,  110, 103, 47,
    83,  116, 114, 105, 110, 103, 59,  41,  76,  106, 97,  118, 97,  47,  108,
    97,  110, 103, 47,  83,  116, 114, 105, 110, 103, 66,  117, 102, 102, 101,
    114, 59,  1,   0,   6,   60,  105, 110, 105, 116, 62,  1,   0,   15,  106,
    97,  118, 97,  47,  108, 97,  110, 103, 47,  67,  108, 97,  115, 115, 1,
    0,   5,   99,  108, 111, 110, 101, 1,   0,   6,   101, 113, 117, 97,  108,
    115, 1,   0,   11,  79,  98,  106, 101, 99,  116, 46,  106, 97,  118, 97,
    1,   0,   36,  106, 97,  118, 97,  47,  108, 97,  110, 103, 47,  67,  108,
    111, 110, 101, 78,  111, 116, 83,  117, 112, 112, 111, 114, 116, 101, 100,
    69,  120, 99,  101, 112, 116, 105, 111, 110, 1,   0,   8,   104, 97,  115,
    104, 67,  111, 100, 101, 1,   0,   8,   102, 105, 110, 97,  108, 105, 122,
    101, 1,   0,   6,   97,  112, 112, 101, 110, 100, 1,   0,   8,   103, 101,
    116, 67,  108, 97,  115, 115, 1,   0,   30,  106, 97,  118, 97,  47,  108,
    97,  110, 103, 47,  73,  110, 116, 101, 114, 114, 117, 112, 116, 101, 100,
    69,  120, 99,  101, 112, 116, 105, 111, 110, 1,   0,   3,   40,  41,  86,
    0,   1,   0,   9,   0,   0,   0,   0,   0,   0,   0,   12,  1,   17,  0,
    60,  0,   29,  0,   0,   1,   1,   0,   57,  0,   28,  0,   0,   0,   1,
    0,   54,  0,   26,  0,   1,   0,   38,  0,   0,   0,   33,  0,   2,   0,
    2,   0,   0,   0,   9,   42,  43,  165, 0,   5,   3,   172, 4,   172, 0,
    0,   0,   1,   0,   35,  0,   0,   0,   6,   0,   1,   0,   0,   0,   57,
    1,   4,   0,   53,  0,   47,  0,   1,   0,   33,  0,   0,   0,   4,   0,
    1,   0,   6,   0,   1,   0,   40,  0,   27,  0,   1,   0,   38,  0,   0,
    0,   74,  0,   3,   0,   1,   0,   0,   0,   42,  187, 0,   4,   89,  183,
    0,   11,  42,  182, 0,   10,  182, 0,   14,  182, 0,   15,  18,  2,   182,
    0,   15,  42,  182, 0,   12,  4,   120, 4,   124, 16,  16,  184, 0,   13,
    182, 0,   15,  182, 0,   16,  176, 0,   0,   0,   1,   0,   35,  0,   0,
    0,   14,  0,   3,   0,   0,   0,   76,  0,   22,  0,   77,  0,   38,  0,
    76,  1,   17,  0,   46,  0,   62,  0,   0,   1,   17,  0,   32,  0,   62,
    0,   0,   1,   17,  0,   39,  0,   45,  0,   1,   0,   33,  0,   0,   0,
    4,   0,   1,   0,   3,   0,   17,  0,   39,  0,   48,  0,   2,   0,   38,
    0,   0,   0,   62,  0,   4,   0,   4,   0,   0,   0,   26,  29,  18,  1,
    162, 0,   13,  29,  153, 0,   13,  31,  9,   148, 154, 0,   7,   31,  10,
    97,  64,  42,  31,  182, 0,   17,  177, 0,   0,   0,   1,   0,   35,  0,
    0,   0,   18,  0,   4,   0,   0,   0,   135, 0,   16,  0,   136, 0,   20,
    0,   137, 0,   25,  0,   134, 0,   33,  0,   0,   0,   4,   0,   1,   0,
    3,   0,   17,  0,   39,  0,   62,  0,   2,   0,   38,  0,   0,   0,   34,
    0,   3,   0,   1,   0,   0,   0,   6,   42,  9,   182, 0,   17,  177, 0,
    0,   0,   1,   0,   35,  0,   0,   0,   10,  0,   2,   0,   0,   0,   150,
    0,   5,   0,   149, 0,   33,  0,   0,   0,   4,   0,   1,   0,   3,   0,
    4,   0,   58,  0,   62,  0,   2,   0,   38,  0,   0,   0,   25,  0,   0,
    0,   1,   0,   0,   0,   1,   177, 0,   0,   0,   1,   0,   35,  0,   0,
    0,   6,   0,   1,   0,   0,   0,   160, 0,   33,  0,   0,   0,   4,   0,
    1,   0,   8,   0,   1,   0,   51,  0,   62,  0,   1,   0,   38,  0,   0,
    0,   25,  0,   0,   0,   1,   0,   0,   0,   1,   177, 0,   0,   0,   1,
    0,   35,  0,   0,   0,   6,   0,   1,   0,   0,   0,   29,  0,   1,   0,
    36,  0,   0,   0,   2,   0,   55};

static void test_parse_classfile(void) {
    struct classfile classfile;
    bool success;

    success = parse_classfile(&classfile, sizeof(bytes_Object_class) - 1,
                              bytes_Object_class);
    assert(!success);

    success = parse_classfile(&classfile, sizeof(bytes_Object_class) + 1,
                              bytes_Object_class);
    assert(!success);

    success = parse_classfile(&classfile, sizeof(bytes_Object_class),
                              bytes_Object_class);
    assert(success);

    assert(classfile.magic == 0xCAFEBABE);
    assert(classfile.minor_version == 3);
    assert(classfile.major_version == 45);
    assert(classfile.constant_pool_count == 63);
    assert(classfile.constant_pool != NULL);

    for (int i = 1; i < classfile.constant_pool_count; i++) {
        struct cp_info cp_entry = classfile.constant_pool[i];

        if (i <= 1)
            assert(cp_entry.tag == CONSTANT_Integer);
        else if (i <= 2)
            assert(cp_entry.tag == CONSTANT_String);
        else if (i <= 9)
            assert(cp_entry.tag == CONSTANT_Class);
        else if (i <= 17)
            assert(cp_entry.tag == CONSTANT_Methodref);
        else if (i <= 25)
            assert(cp_entry.tag == CONSTANT_NameAndType);
        else
            assert(cp_entry.tag == CONSTANT_Utf8);
    }

    assert(classfile.access_flags == ACC_PUBLIC);
    assert(classfile.this_class == 9);
    assert(classfile.super_class == 0);
    assert(classfile.interfaces_count == 0);
    assert(classfile.interfaces == NULL);
    assert(classfile.fields_count == 0);
    assert(classfile.fields == NULL);
    assert(classfile.methods_count == 12);
    assert(classfile.methods != NULL);
    assert(classfile.attributes_count == 1);
    assert(classfile.attributes != NULL);
}

int main(void) {
    test_parse_classfile();

    return 0;
}
